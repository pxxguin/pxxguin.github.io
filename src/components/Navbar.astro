---
import { Icon } from "astro-icon/components";
import { navBarConfig, siteConfig } from "../config";
import { LinkPresets } from "../constants/link-presets";
import {
	LinkPreset,
	type NavBarDropdown,
	type NavBarLink,
} from "../types/config";
import { url } from "../utils/url-utils";
import LightDarkSwitch from "./LightDarkSwitch.svelte";
import Search from "./Search.svelte";
import NavMenuPanel from "./widget/NavMenuPanel.astro";

interface Props {
	class?: string;
	isHome?: boolean;
}

const { class: className, isHome } = Astro.props;

let links: (NavBarLink | NavBarDropdown)[] = navBarConfig.links.map(
	(
		item: NavBarLink | LinkPreset | NavBarDropdown,
	): NavBarLink | NavBarDropdown => {
		if (typeof item === "number") {
			return LinkPresets[item];
		}
		return item as NavBarLink | NavBarDropdown;
	},
);
---
<div id="navbar" class="z-50 onload-animation">
    <div class="absolute h-8 left-0 right-0 -top-8 bg-[var(--card-bg)] transition"></div> <!-- used for onload animation -->
    <div class:list={[
        className,
        "card-base !overflow-visible max-w-[var(--page-width)] h-[4.5rem] !rounded-t-none mx-auto flex items-center justify-between px-4 relative",
        { "text-white dark:text-white": isHome }
    ]}>
        
        <!-- LEFT: Logo -->
        <div class="flex flex-1 items-center justify-start">
            <a href={url('/')} class="btn-plain scale-animation rounded-lg h-[3.25rem] px-5 font-bold active:scale-95 flex items-center">
                <div id="nav-logo" class="flex flex-row text-[var(--primary)] items-center text-xl cursor-pointer">
                    <Icon name="fa6-solid:compact-disc" class="text-[2rem] mr-2 animate-[spin_5s_linear_infinite]" />
                    {siteConfig.title}
                </div>
            </a>
        </div>

        <!-- CENTER: Desktop Links (Mega Menu & Regular Links) -->
        <div class="hidden md:flex flex-[2] justify-center h-full items-center gap-1">
            {links.map((l) => {
                const isDropdown = 'categories' in l;
                if (!isDropdown) {
                    return <a aria-label={l.name} href={l.external ? l.url : url(l.url)} target={l.external ? "_blank" : null}
                              class:list={[
                                  "btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95 flex items-center whitespace-nowrap",
                                  { "!text-white hover:!text-[var(--primary)]": isHome }
                              ]}
                    >
                        <div class="flex items-center">
                            {l.name}
                            {l.external && <Icon name="fa6-solid:arrow-up-right-from-square" class="text-[0.875rem] transition -translate-y-[1px] ml-1 text-black/[0.2] dark:text-white/[0.2]"></Icon>}
                        </div>
                    </a>;
                } else {
                    return (
                        <div class="group h-full flex items-center relative">
                            <button class:list={[
                                "btn-plain rounded-lg h-11 font-bold px-5 flex items-center gap-1 whitespace-nowrap",
                                { "!text-white hover:!text-[var(--primary)]": isHome }
                            ]}>
                                {l.name}
                                <Icon name="material-symbols:keyboard-arrow-down-rounded" class="text-xl transition-transform group-hover:rotate-180" />
                            </button>
                            
                            <!-- Mega Menu Dropdown Container -->
                            <div class="absolute top-full left-0 pt-2 opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto transition-all duration-300 translate-y-2 group-hover:translate-y-0 z-50">
                                <div class="min-w-[20rem] w-max max-w-[90vw] bg-[var(--card-bg)] text-black/75 dark:text-white/75 shadow-2xl rounded-2xl border border-black/5 dark:border-white/5 flex overflow-hidden">
                                    <div class="flex-1 p-8 grid grid-cols-1 md:grid-cols-2 gap-8 whitespace-nowrap">
                                        {l.categories.map((cat: any) => (
                                            <div>
                                                <div class="text-[var(--primary)] font-bold mb-4 uppercase text-sm tracking-wider flex items-center gap-2">
                                                    {cat.name}
                                                </div>
                                                <ul class="space-y-3">
                                                    {cat.links.map((link: any) => (
                                                        <li>
                                                            <a href={url(link.url)} class="hover:text-[var(--primary)] transition flex items-center gap-2 font-medium group/link">
                                                                <span class="flex items-center gap-2 w-full">
                                                                    <Icon name="material-symbols:chevron-right-rounded" class="text-[var(--primary)] opacity-0 -translate-x-2 transition-all group-hover/link:opacity-100 group-hover/link:translate-x-0" />
                                                                    <span class="-ml-6 group-hover/link:ml-0 transition-all">{link.name}</span>
                                                                </span>
                                                            </a>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ))}
                                    </div>
                                    {l.promoImage && (
                                        <div class="w-64 bg-black/5 dark:bg-white/5 relative group/promo overflow-hidden hidden lg:block">
                                            <a href={url(l.promoUrl || '#')} class="block w-full h-full">
                                                <img src={l.promoImage} alt="Promo" class="w-full h-full object-cover transition duration-700 group-hover/promo:scale-105" />
                                                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent flex items-end p-6">
                                                    <div class="text-white font-bold text-lg mb-2 flex items-center gap-2 whitespace-normal">
                                                        Explore More <Icon name="material-symbols:arrow-forward-rounded" class="transition-transform group-hover/promo:translate-x-1" />
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    );
                }
            })}
        </div>

        <!-- RIGHT: Tools & Mobile Menu -->
        <div class="flex flex-1 justify-end gap-4 items-center">
            <Search client:only="svelte" isHome={isHome}></Search>
            <LightDarkSwitch client:only="svelte" isHome={isHome}></LightDarkSwitch>
            <button aria-label="Menu" name="Nav Menu" class:list={["btn-plain scale-animation rounded-lg w-11 h-11 active:scale-90 md:!hidden", { "!text-white": isHome }]} id="nav-menu-switch">
                <Icon name="material-symbols:menu-rounded" class="text-[1.25rem]"></Icon>
            </button>
        </div>

        <NavMenuPanel links={links}></NavMenuPanel>
    </div>
</div>

<script>
function switchTheme() {
    if (localStorage.theme === 'dark') {
        document.documentElement.classList.remove('dark');
        localStorage.theme = 'light';
    } else {
        document.documentElement.classList.add('dark');
        localStorage.theme = 'dark';
    }
}

function loadButtonScript() {
    let switchBtn = document.getElementById("scheme-switch");
    if (switchBtn) {
        switchBtn.onclick = function () {
            switchTheme()
        };
    }



    let menuBtn = document.getElementById("nav-menu-switch");
    if (menuBtn) {
        menuBtn.onclick = function () {
            let menuPanel = document.getElementById("nav-menu-panel");
            if (menuPanel) {
                menuPanel.classList.toggle("float-panel-closed");
            }
        };
    }
}

loadButtonScript();

function enableLogoSpin() {
    const logo = document.getElementById("nav-logo");
    if (!logo) return;

    logo.addEventListener("click", (e) => {
        e.preventDefault();
        // Remove class to reset animation if clicked quickly
        logo.classList.remove("animate-glitch");
        void logo.offsetWidth; // Trigger reflow
        logo.classList.add("animate-glitch");
        
        // Remove after 500ms
        setTimeout(() => {
            logo.classList.remove("animate-glitch");
        }, 500);
    });
}
enableLogoSpin();
</script>

{import.meta.env.PROD && <script is:inline define:vars={{scriptUrl: url('/pagefind/pagefind.js')}}>
async function loadPagefind() {
    try {
        const response = await fetch(scriptUrl, { method: 'HEAD' });
        if (!response.ok) {
            throw new Error(`Pagefind script not found: ${response.status}`);
        }

        const pagefind = await import(scriptUrl);

        await pagefind.options({
            excerptLength: 20
        });

        window.pagefind = pagefind;

        document.dispatchEvent(new CustomEvent('pagefindready'));
        console.log('Pagefind loaded and initialized successfully, event dispatched.');
    } catch (error) {
        console.error('Failed to load Pagefind:', error);
        window.pagefind = {
            search: () => Promise.resolve({ results: [] }),
            options: () => Promise.resolve(),
        };
        document.dispatchEvent(new CustomEvent('pagefindloaderror'));
        console.log('Pagefind load error, event dispatched.');
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadPagefind);
} else {
    loadPagefind();
}
</script>}

<style is:global>
    @keyframes glitch-anim {
        0% { transform: translate(0) }
        20% { transform: translate(-2px, 2px) }
        40% { transform: translate(-2px, -2px) }
        60% { transform: translate(2px, 2px) }
        80% { transform: translate(2px, -2px) }
        100% { transform: translate(0) }
    }
    .animate-glitch {
        animation: glitch-anim 0.3s cubic-bezier(.25, .46, .45, .94) both infinite;
        color: #ff00ff !important; /* Cyberpunk Pink */
        text-shadow: 2px 0 #00ffff; /* Cyberpunk Cyan shadow */
    }
</style>
